# Phase 3: AI Agent & Search - 規格規劃文檔

本文件詳細規劃 Vibe Commerce 平台的 Phase 3 開發，核心在於整合 Gemini 1.5 Flash 驅動的智慧導購助手、建立基於向量嵌入的語義搜尋系統，並透過動態 UI 動畫提升整體視覺質感。

## 1. 核心目標 (Core Objectives)

*   **智慧導購助手**: 提供流暢的自然語言交互，協助用戶篩選商品、獲取建議。
*   **語義搜尋系統**: 超越傳統關鍵字匹配，實現基於意圖與上下文的商品檢索。
*   **動態視覺體驗**: 透過精細的動畫與狀態過度，營造「Vibe」品牌感。
*   **邊緣計算優化**: 確保所有 AI 邏輯在 Cloudflare Workers 上高效執行，維持零冷啟動特性。

---

## 2. AI 代理架構 (AI Agent Architecture)

### 2.1 模型與引擎
*   **核心模型**: Gemini 1.5 Flash。選擇其原因為極低的推論延遲、寬廣的上下文窗口以及對於複雜指令的高度遵循能力。
*   **傳輸協議**: 採用 Server-Sent Events (SSE) 實現串流回應 (Streaming)，確保用戶能即時看到 AI 生成的文字，優化感知性能。

### 2.2 提示詞工程 (Prompt Engineering)
*   **系統人格設定**: 定位為「高端 Vibe 購物顧問」，語氣需專業、親切且具備時尚洞察力。
*   **限制規範**: 
    *   僅回答與商品、訂單及購物流程相關的問題。
    *   嚴禁產生虛假商品連結或虛構庫存資訊。
    *   當涉及敏感操作（如個人資料修改）時，需導向官方 UI 路徑。
*   **上下文感知**: 每次請求將附帶用戶當前瀏覽的商品 ID、最近三筆訂單摘要（若已登入）以及過去 5 輪的對話歷史。

---

## 3. 語義搜尋與向量檢索 (Semantic Search & Vectorization)

### 3.1 向量化流程 (Embedding Pipeline)
*   **商品向量化**: 當後台更新商品（名稱、描述、類別）時，觸發背景工作調用 Embedding API (Gemini 或 Cloudflare Workers AI) 生成向量。
*   **儲存載體**: 向量數據儲存於 D1 資料庫的專用欄位，或利用 Cloudflare Vectorize 進行高效索引。

### 3.2 檢索邏輯
*   **混合搜尋 (Hybrid Search)**: 結合 D1 全文搜索 (FTS) 與向量相似度計算（餘弦相似度），確保針對特定品牌名稱的精確匹配與針對模糊描述的感性匹配。
*   **多樣性過濾**: 檢索結果需排除重複度過高的變體，提供更多元化的視覺呈現。

---

## 4. 動態 UI 與交互動畫 (Dynamic UI & Animations)

### 4.1 AI 互動狀態
*   **思考與打字**: 當 AI 處理時，顯示精美的波浪狀載入動畫；文字產出時伴隨細微的打字效果。
*   **推薦卡片彈出**: AI 推薦商品時，商品卡片應以交錯動畫 (Staggered Animation) 從對話框中優雅彈出，而非瞬間顯示。

### 4.2 頁面過渡
*   **Shared Layout Transitions**: 點擊搜尋結果進入商品詳情頁時，使用圖片共享佈局動畫，增強導覽的連貫性。
*   **購物車動效**: 商品加入購物車時，右側抽屜平滑滑入，並伴隨庫存數字的滾動動畫。

---

## 5. 安全性與 API 規範 (Security & API Protocols)

### 5.1 身份驗證與授權
*   **嚴格驗證**: 所有 AI 相關端點必須通過 Clerk JWT 驗證。匿名用戶僅限於基本的公開商品搜尋。
*   **用戶隔離**: 查詢個人訂單或日誌時，後端強制執行 Row Level Security (RLS)，確保 AI 無法讀取跨用戶數據。

### 5.2 資料校驗 (Zod Checking)
*   **查詢對象**: 驗證 Prompt 長度、特殊字符過濾。
*   **分頁參數**: 嚴格檢查 Offset 與 Limit，防止深度分頁造成的性能壓力。

### 5.3 防禦性設計
*   **速率限制 (Rate Limiting)**: 針對單一用戶設置 AI 請求配額，防止 API 費用異常飆升。
*   **回退機制**: 若 Gemini 服務不可用，系統自動切換回基礎全文搜索，並顯示提示訊息。

---

## 6. 資料庫操作流程 (Database Logic Flow)

### 6.1 搜尋交互流程
1.  用戶發送自然語言查詢。
2.  Worker 將查詢文字轉換為向量嵌入。
3.  執行 D1 SQL 查詢，利用向量運算符找出相似度前 N 名的商品 ID。
4.  關聯查詢商品完整資訊（名稱、價格、主圖）。
5.  將結果返回前端並觸發動態渲染。

### 6.2 AI 導購記錄流程
1.  捕捉對話內容與 AI 生成的推薦建議。
2.  非同步寫入 `AI Interaction Logs`，包含輸入向量（用於後續偏好分析）。
3.  更新用戶的「近期興趣標籤」，作為未來個性化首頁的參考。

---

## 7. 待執行清單 (Phase 3 TODOs)

- [ ] 設定 Gemini 1.5 Flash API Key 至 Cloudflare Secrets。
- [ ] 實作後端 `/api/ai/chat` 串流端點。
- [ ] 整合 `Vectorize` 或在 D1 中配置向量檢索邏輯。
- [ ] 在前端開發 AI 懸浮對話組件，並整合動態動畫庫。
- [ ] 建立語義搜尋專用的 Zod 驗證 Schema 與錯誤處理流程。
- [ ] 測試在高併發下的邊緣執行延遲，優化 Token 消耗。

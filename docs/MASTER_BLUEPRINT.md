# 主藍圖：Vibe Coding 電子商務平台

本文件概述了高端、代理式電子商務平台的設計與開發藍圖，該平台旨在展示「Vibe Coding」的卓越性，並透過高度結構化、安全且零冷啟動的架構，提供無與倫比的購物體驗。

## 1. 系統架構

該平台採用現代化的邊緣優先架構，利用 Cloudflare 的全球網路實現高性能和可靠性。

### 1.1 Cloudflare Pages (前端)

Cloudflare Pages 作為平台的使用者介面，託管基於 Next.js 16+ 的反應式前端應用程式。它透過內容傳遞網路 (CDN) 全球分發，確保使用者無論身處何地都能獲得快速的頁面載入速度和流暢的互動體驗。所有靜態資產和前端邏輯都在此處處理，實現了高度的可擴展性和零冷啟動。

### 1.2 Cloudflare Workers (後端 API)

Cloudflare Workers 提供無伺服器後端 API 層。這些輕量級、高效的 JavaScript 函數在全球數百個邊緣位置執行，非常靠近使用者。它們負責處理業務邏輯、資料驗證、身份驗證中介以及與資料庫的互動。Workers 的邊緣執行特性極大地減少了延遲，消除了傳統伺服器的冷啟動問題，並提供了強大的擴展能力。

### 1.3 Cloudflare D1 (邊緣 SQL 資料庫)

Cloudflare D1 是一個分佈式、邊緣優先的 SQL 資料庫，為平台的所有資料提供持久儲存。它利用 SQLite 技術，將資料副本儲存在全球各地的邊緣節點上。這確保了 Workers 能夠在極低延遲的情況下訪問資料，無需跨越遙遠的距離與集中式資料庫通信。D1 支援 SQL 標準，並提供了高可用性和資料冗餘。

### 1.4 系統互動流程

使用者透過 Cloudflare Pages 載入前端應用程式。前端應用程式向部署在全球邊緣的 Cloudflare Workers 發送 API 請求。Workers 接收請求後，執行業務邏輯，並透過本地或最近的邊緣副本與 Cloudflare D1 資料庫互動，以讀取或寫入資料。D1 將請求的結果返回給 Worker，Worker 進而將處理後的響應傳回給前端應用程式，最終顯示給使用者。整個過程在邊緣高效完成，確保了端到端的低延遲和卓越性能。

## 2. 資料建模

以下是平台關鍵邏輯實體及其關係的定義：

### 2.1 Users (使用者)

*   **目的**：儲存平台使用者的基本檔案資訊，並與認證系統連結。
*   **屬性**：
    *   使用者唯一識別碼 (主鍵)
    *   Clerk 認證系統提供的外部識別碼 (唯一，與 Clerk 使用者連結)
    *   電子郵件地址 (唯一)
    *   顯示名稱
    *   個人資料圖片 URL
    *   建立時間戳
    *   上次更新時間戳
*   **關係**：一對多關係，一個使用者可以擁有多個訂單。

### 2.2 Products (產品)

*   **目的**：儲存電子商務平台上的所有產品詳細資訊、庫存和定價。
*   **屬性**：
    *   產品唯一識別碼 (主鍵)
    *   產品名稱
    *   產品描述 (詳細文本)
    *   價格 (十進位數)
    *   庫存數量 (整數)
    *   產品圖片 URL 列表
    *   類別
    *   品牌
    *   產品狀態 (例如：有庫存、缺貨、預售)
    *   向量嵌入 (JSON 或 BLOB 類型，用於 AI 語義搜尋)
    *   建立時間戳
    *   上次更新時間戳
*   **關係**：一對多關係，一個產品可以出現在多個訂單項目中。

### 2.3 Orders (訂單)

*   **目的**：記錄使用者的購物訂單、訂單項目和訂單狀態。
*   **屬性**：
    *   訂單唯一識別碼 (主鍵)
    *   使用者識別碼 (外鍵，連結至 `Users` 實體)
    *   訂單總金額 (十進位數)
    *   訂單狀態 (例如：待處理、已確認、已發貨、已完成、已取消)
    *   送貨地址
    *   帳單地址
    *   付款狀態
    *   下訂單時間戳
    *   上次更新時間戳
*   **關係**：
    *   一對一關係，一個訂單有多個訂單項目。
    *   多對一關係，多個訂單屬於一個使用者。

### 2.4 OrderItems (訂單項目)

*   **目的**：詳細說明每個訂單中的具體產品和數量。
*   **屬性**：
    *   訂單項目唯一識別碼 (主鍵)
    *   訂單識別碼 (外鍵，連結至 `Orders` 實體)
    *   產品識別碼 (外鍵，連結至 `Products` 實體)
    *   購買數量 (整數)
    *   單價 (十進位數，記錄下訂單時的價格)
    *   總價 (十進位數)
*   **關係**：多對一關係，多個訂單項目屬於一個訂單。

### 2.5 AI Interaction Logs (AI 互動日誌)

*   **目的**：記錄 AI 代理的互動、搜尋查詢、推薦和相關的向量嵌入。
*   **屬性**：
    *   日誌唯一識別碼 (主鍵)
    *   使用者識別碼 (外鍵，連結至 `Users` 實體，可為空，用於匿名互動)
    *   互動類型 (例如：搜尋、推薦、對話)
    *   查詢文本 (如果適用)
    *   回應文本 (如果適用)
    *   相關產品識別碼列表 (JSON 格式，如果 AI 推薦了產品)
    *   輸入向量嵌入 (JSON 或 BLOB 類型，例如搜尋查詢的嵌入)
    *   輸出向量嵌入 (JSON 或 BLOB 類型，例如推薦結果的嵌入)
    *   互動時間戳
    *   會話識別碼 (用於追蹤一系列相關互動)
*   **關係**：多對一關係，多個 AI 互動日誌可以與一個使用者相關聯。

## 3. 安全協定

安全性是本平台的基石，透過分層防禦機制實現。

### 3.1 Clerk 認證與邊緣驗證

*   **使用者認證**：Clerk Auth 負責處理所有使用者的註冊、登入和會話管理。Clerk 提供了安全的使用者認證流程和可靠的身份管理。
*   **邊緣令牌驗證**：當使用者登入後，Clerk 會發行一個 JWT (JSON Web Token)。前端應用程式將此令牌包含在其向 Cloudflare Workers 發送的所有 API 請求中。
*   **Workers 驗證**：每個 Cloudflare Worker 在處理任何受保護的 API 請求之前，都必須驗證接收到的 Clerk JWT。這包括：
    *   **簽章驗證**：使用 Clerk 提供的公開金鑰驗證 JWT 的簽章，確保令牌未被篡改。
    *   **過期時間驗證**：檢查令牌的過期時間，拒絕所有過期令牌。
    *   **發行者驗證**：確認令牌是由預期的 Clerk 實例發行的。
    *   **受眾驗證**：確認令牌是為預期的應用程式受眾發行的。
    *   **使用者識別碼提取**：從有效令牌中提取使用者的唯一識別碼，此識別碼將用於 Row Level Security (RLS) 和其他授權決策。
*   **授權決策**：只有經過成功驗證並授權的請求才能繼續執行其業務邏輯，並與 D1 資料庫互動。

### 3.2 D1 資料庫中的 Row Level Security (RLS)

D1 資料庫將實施 Row Level Security (RLS) 以確保資料的機密性和完整性。

*   **RLS 邏輯**：RLS 透過在資料庫層應用策略來限制使用者對特定行資料的訪問。這表示，即使 Worker 程式碼可能包含允許訪問所有行的查詢，RLS 策略也會自動過濾結果，只顯示使用者被授權查看的資料。
*   **實施細節**：
    *   **使用者識別碼傳遞**：經過驗證的 Clerk 使用者識別碼將從 Cloudflare Worker 安全地傳遞給 D1 資料庫，通常作為資料庫會話變數或查詢參數。
    *   **策略定義**：為敏感資料表 (例如 `Orders`、`AI Interaction Logs`) 定義 RLS 策略。這些策略會根據當前使用者的識別碼來限制對行的訪問。
    *   **範例 RLS 策略**：
        *   對於 `Orders` 表，策略將確保使用者只能看到他們自己創建的訂單。即：`WHERE user_id = current_authenticated_user_id`。
        *   對於 `AI Interaction Logs` 表，策略將確保使用者只能查看或修改他們自己的 AI 互動日誌。
*   **優勢**：RLS 在資料庫層強制執行授權，減少了在應用程式層犯錯的可能性，並提供了一致的資料訪問控制。這對於多租戶環境尤其重要，可以防止資料洩露。

## 4. AI 整合：Gemini 驅動的購物代理

平台的核心將是一個由 Gemini 提供支援的智能購物代理，旨在提供個性化的產品發現和推薦體驗。

### 4.1 語義搜尋流程

1.  **使用者查詢**：使用者輸入自然語言搜尋查詢 (例如：「我想找一雙舒適的白色運動鞋」)。
2.  **查詢嵌入**：Cloudflare Worker 將使用者查詢發送給 Gemini 模型，生成一個代表查詢語義含義的向量嵌入。
3.  **向量搜尋**：Worker 將此查詢嵌入發送給 D1 資料庫。
4.  **D1 向量匹配**：D1 資料庫的 `Products` 表中的 `向量嵌入` 屬性將用於執行近似最近鄰 (ANN) 搜尋。這意味著資料庫會找到其向量嵌入與使用者查詢嵌入最「相似」的產品。這個過程在資料庫層高效執行，利用 D1 處理向量資料的能力。
5.  **產品檢索與排序**：D1 返回與語義查詢最相關的產品列表，這些產品根據其相似度分數進行排序。
6.  **結果呈現**：Cloudflare Worker 接收這些產品，並將它們傳回給前端應用程式，顯示給使用者。

### 4.2 個人化推薦流程

1.  **行為收集**：系統透過追蹤使用者的瀏覽歷史、購買記錄和 AI 互動日誌 (例如，過去的搜尋查詢嵌入、點擊的產品) 來收集使用者行為資料。
2.  **使用者偏好建模**：Cloudflare Worker 利用這些行為資料，並可能結合 Gemini 模型，為每個使用者構建一個動態的「使用者偏好向量」或「興趣概況」。這可能涉及聚合過去的產品嵌入、AI 查詢嵌入等。
3.  **推薦生成**：當使用者訪問產品頁面或主頁時，Worker 會將此使用者偏好向量與 `Products` 表中的產品向量嵌入進行比較。
4.  **D1 推薦查詢**：D1 執行另一個向量相似度搜尋，以找到與使用者偏好向量最匹配的產品。
5.  **推薦呈現**：將推薦的產品返回給使用者，提供高度個人化的購物建議。
6.  **反饋迴圈**：系統不斷監控使用者對推薦產品的互動 (例如：點擊、添加到購物車)，並利用這些反饋來迭代和改進使用者的偏好模型和推薦演算法。

## 5. 分階段開發路線圖

### 5.1 階段 1: 基礎設施設置與核心服務

*   **目標**：建立所有必要的基礎設施，並部署核心認證和資料庫服務。
*   **主要目標**：
    *   設定 Cloudflare Pages 專案以託管 Next.js 應用程式。
    *   設定 Cloudflare Workers 專案作為 API 網關。
    *   初始化 Cloudflare D1 資料庫並定義初始資料表結構 (Users、Products、Orders、OrderItems)。
    *   整合 Clerk Auth 進行使用者認證和會話管理。
    *   在 Cloudflare Workers 中實施 Clerk JWT 令牌驗證機制。
    *   建立基礎的 CI/CD 管道。

### 5.2 階段 2: 前端與基本電子商務功能

*   **目標**：開發前端應用程式並實施核心電子商務功能。
*   **主要目標**：
    *   開發 Next.js 前端應用程式，包括主頁、產品列表頁和產品詳情頁。
    *   實施使用者註冊、登入和檔案管理功能。
    *   建立產品資料管理 API (CRUD 操作) 在 Workers 中。
    *   在 D1 中實施產品資料模型。
    *   開發購物車功能和基本結帳流程。
    *   在 D1 資料庫中實施 Row Level Security (RLS) 以保護使用者資料和訂單資料。

### 5.3 階段 3: 高級功能與 AI 整合

*   **目標**：整合 Gemini AI 代理，實現語義搜尋和個人化推薦，並增強平台功能。
*   **主要目標**：
    *   整合 Gemini API 進行文本嵌入生成。
    *   為 `Products` 表添加向量嵌入儲存。
    *   在 Cloudflare Workers 中實施語義搜尋邏輯，利用 D1 進行向量相似度查詢。
    *   開發 AI 驅動的產品推薦系統。
    *   實施 `AI Interaction Logs` 資料模型和相關 API。
    *   開發詳細的訂單管理和歷史記錄功能。

### 5.4 階段 4: 優化、測試與部署

*   **目標**：對整個平台進行性能優化、徹底測試，並最終部署到生產環境。
*   **主要目標**：
    *   執行全面的單元測試、整合測試和端到端測試。
    *   進行性能基準測試和負載測試，識別並解決潛在瓶頸。
    *   優化 D1 資料庫查詢和索引以提高效率。
    *   配置 Cloudflare Workers 的緩存策略。
    *   實施監控和日誌記錄解決方案。
    *   進行安全審計和滲透測試。
    *   準備並執行生產部署。
    *   建立完善的維護和支援流程。

此藍圖為一個高性能、安全且智能的代理式電子商務平台奠定了堅實的基礎，充分利用了 Cloudflare 和 Gemini 的先進技術。
